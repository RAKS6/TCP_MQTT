name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential gcc g++ make libpaho-mqtt3c-dev python3-pip
        pip3 install pytest paho-mqtt

    - name: Compile Server
      run: |
        gcc server.c mqtt.c -o server -lpaho-mqtt3c -lpthread

    - name: Compile Clients
      run: |
        gcc client.c -o client
        gcc client2.c -o client2

    - name: Start TCP Server in background
      run: |
        ./server &
        echo $! > server_pid.txt
      shell: bash

    - name: Wait for Server to start
      run: sleep 2

    - name: Run Python Tests
      run: pytest test_tcp.py -v

    - name: Stop TCP Server
      run: |
        kill $(cat server_pid.txt)
